# ScanServer

Локальный Python-клиент (Python 3.12) для работы с промышленными
QR/штрих-сканерами по COM-порту. Поддерживает несколько физических
сканеров одновременно, изолированные сессии, режимы обработки
(COMPARE_FILL, DEFECT, TRANSFER, TRANSFER_DEFECT), озвучку через
edge-tts с кэшированием и fallback, работу с Laravel API.

------------------------------------------------------------------------

# Возможности

## Многосканерная архитектура

-   Каждый физический сканер = отдельная сессия
-   Свой device_id
-   Свой текущий пользователь
-   Свой режим работы
-   Изоляция потоков

## Управление пользователями

-   Установка пользователя через QR: `SVC:USER:{id}`
-   Повторный скан того же ID → снимает пользователя
-   Скан другого ID → переключает пользователя
-   Автоматический сброс через 15 минут без активности
-   При запуске программы пользователь всегда отсутствует

## Режимы работы

Переключение режимов сервисными QR:

SVC:MODE:COMPARE_FILL\
SVC:MODE:DEFECT\
SVC:MODE:TRANSFER\
SVC:MODE:TRANSFER_DEFECT

------------------------------------------------------------------------

# COMPARE_FILL

Логика: 1. Первый скан → сохраняется 2. Второй скан → сравнение 3. Если
совпало → отправка action=done 4. Если нет → "Не верно"

Поддерживаемые форматы:

WALLPAPER\|v=1\|oi=1\|art=DL-001\|w=300\|h=270\|panels=3\|kind=striped\|lk=...\|code=...

Берётся art=DL-001

FFO-065_500х270\|0

Берётся FFO-065_500х270

------------------------------------------------------------------------

# DEFECT

После сканирования рабочего QR открывается окно: - Пользователь - Тип
изделия (Футболки / Обои) - Поле ввода - Комментарий - Отправить /
Отмена

### Футболки

Вводится общее количество:
Футболки → qty\

### Обои
Вводятся номера полотен:
Полотна = 1,2,3

→ преобразуется в:
```json
"panels": [1,2,3]
```
action = "defect"

------------------------------------------------------------------------

# TRANSFER

Скан QR → окно размеров: XS, S, M, L, XL, 2XL, 3XL, 4XL, 5XL

Формируется done_map:
```json
{ "XS": 5, "M": 2 }
```
action = "done"

------------------------------------------------------------------------

# TRANSFER_DEFECT

Аналог TRANSFER, но: - есть комментарий - action = "defect"


# Работа с сервером

## Получение пользователя

    GET /api/v1/users/{id}

### Ответ:

``` json
{
  "id": 8,
  "name": "Admin Root"
}
```

### Ошибки:

-   404 → "Неверный id пользователя"
-   Network error → "Нет соединения с сервером"

------------------------------------------------------------------------

## Формат отправки на сервер

### Общий формат:

``` json
{
  "payload": "RAW_QR_STRING",
  "action": "done | defect",
  "user_id": 8,
  "device_id": "BG01",
  "client_ts": "2026-02-10T17:10:57+03:00"
}
```

### Дополнительно в зависимости от режима:

#### DONE (TRANSFER)

``` json
"done_map": {
  "XS": 5,
  "L": 2
}
```

#### DEFECT (WALLPAPER)

``` json
"panels": [1,2,3]
```

#### DEFECT (TSHIRT)

``` json
"qty": 3
```

#### Комментарий

``` json
"reason": "кривой перенос"
```

------------------------------------------------------------------------

# Озвучка (TTS)

## Основной движок

-   edge-tts

## Возможности

-   Кэширование mp3
-   Настраиваемая скорость речи
-   Поддержка нескольких одновременных сканеров
-   Автоматический префикс device_id и пользователя

### Пример озвучки:

    BG-01. Первый принят.

------------------------------------------------------------------------

# Настройки

## Python

-   Версия: 3.12
-   Работа через `.venv`

## Зависимости

-   pyserial
-   httpx
-   edge-tts
-   pygame
-   pyttsx3 (fallback)

## API base URL

### Dev

    http://127.0.0.1:8000

### Prod

    https://customcraft-mes.ru

------------------------------------------------------------------------

# COM-порты

Каждый сканер: - свой COM - свой device_id - отдельный поток чтения -
буферизация до newline

------------------------------------------------------------------------

# Автосброс пользователя

Если: - пользователь установлен - нет сканов 15 минут

→ пользователь автоматически снимается

------------------------------------------------------------------------

# Потоки:

-   COM reader
-   Idle watchdog
-   UI
-   TTS loop

------------------------------------------------------------------------

# Лицензия

Internal production tool.\
Используется внутри системы CustomCraft MES.

